<!doctype html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
    <title>test</title>
    <script type="text/javascript" src="./static/js/jquery-3.3.1.min.js"></script>
    <link rel="stylesheet" type="text/css" href="./static/css/styles.css">
</head>
<body>

<div id="bought_list">
    <table>

    </table>
</div>

<div class="left_box"></div>

<div class="opacity"></div>

<div class="right_box"></div>

<div class="clearfix"></div>

<div class="footer">
    <div id="buy_list">
        <table></table>
    </div>
    <div class="left" onclick="show_buy_list()">
        已选：<span id="cartN">
             <span id="totalcountshow">0</span>份　总计：￥<span id="totalpriceshow">0</span>
           </span>元
    </div>
    <div class="right">
        <a id="btnselect" class="xhlbtn" href="javascript:void(0)" onclick="submit();">选好了</a>
    </div>
</div>


<script>
    var furl = 'http://47.93.220.57/';
    var group_number = '';
    var openid = '';

    // 获得url参数
    var Request = new Object();
    Request = GetRequest();

    function GetRequest() {
        var url = location.search;
        var theRequest = new Object();
        if (url.indexOf("?") != -1) {
            var str = url.substr(1);
            strs = str.split("&");
            for (var i = 0; i < strs.length; i++) {
                theRequest[strs[i].split("=")[0]] = decodeURI(strs[i].split("=")[1]);
            }
        }
        return theRequest;
    }


    $(document).ready(function () {
        var code = Request['code'];

        //载入时get请求  获得openid 是否已提交
        //test参数在下面

        $.ajax({
            url: furl + "groupbuying/api/Get_Product_1/5?code=" + code,
            type: 'GET',
            // data: data,
            async: false,
            dataType: 'json',
            xhrFields: {
                withCredentials: true
            },
            crossDomain: true,
            success: function (all, r, xhr) {
                console.log(all);
                console.log(window.sessionStorage);
                openid = all.open_id;
                group_number = all.group_number;
                //已买
                if (all.bought == 1) {
                    $('#bought_list').show();
                    for (var i in all.product) {
                        var card1 = '<tr><td>' + all.product[i].product_name + '</td> <td>' + all.product[i].product_number + '</td></tr>'
                        $('#bought_list table').append(card1);
                    }
                }
                //未买
                if (all.bought == 0) {
                    $('.footer').show();
                    for (var i in all.product) {
                        var card1 = '<div class="pInfo" id="' + all.product[i].product_id + '"><img src="' + all.product[i].product_picture_url + '"/><div class="text"><p class="x-title">' + all.product[i].product_name + '</p> <p class="x-context">' + all.product[i].product_intro + '</p> </div><div class="right_content"> <div class="price">￥' + all.product[i].product_price + '</div> <div class="btn"><button class="minus" disabled="disabled">-</button><i>0</i><button class="add">+</button></div></div></div>'
                        $('.right_box').append(card1);
                    }
                }

            }
        });


        //监视动态结点  添加事件
        $('.right_box').on('click', '.add', function () {
            $(this).prev().prev().removeAttr("disabled");
            var n = $(this).prev().text();
            var num = parseInt(n) + 1;
            if (num == 0) {
                return;
            }
            $(this).prev().text(num);
            var danjia = $(this).parent().siblings('.price').text().replace('￥', '');//获取单价
            var a = $("#totalpriceshow").html();//获取当前所选总价
            $("#totalpriceshow").html((a * 1 + danjia * 1).toFixed(2));//计算当前所选总价
            var nm = $("#totalcountshow").html();//获取数量
            $("#totalcountshow").html(nm * 1 + 1);
        });

        //减的效果
        $('.right_box').on('click', '.minus', function () {
            var n = $(this).next().text();
            var num = parseInt(n) - 1;
            $(this).next().text(num);//减1
            var danjia = $(this).parent().siblings('.price').text().replace('￥', '');
            var a = $("#totalpriceshow").html();//获取当前所选总价
            $("#totalpriceshow").html((a * 1 - danjia * 1).toFixed(2));//计算当前所选总价

            var nm = $("#totalcountshow").html();//获取数量
            $("#totalcountshow").html(nm * 1 - 1);
            //如果数量小于或等于0则隐藏减号和数量
            if (num <= 0) {
                $(this).attr("disabled", "true");
                $(this).attr("disabled", true);
                return
            }
        });


    });

    //未提交时 查看购物车
    $('.opacity').click(function () {
        $('#buy_list').toggle();
        $(this).toggle();
    });

    function show_buy_list() {
        $('#buy_list').toggle();
        $('.opacity').toggle();
        var str = '';
        $('.pInfo').each(function () {
            if ($(this).find('i').text() != 0) {
                var x = '<tr><td>' + $(this).find('.x-title').text() + '</td><td>' + $(this).find('i').text() + '</td></tr>';
                str = str + x;
            }
        });
        $('#buy_list').find('table').html(str);
    }


    //提交购物车
    function submit() {
        var result = [];

        $('.pInfo').each(function () {
            if ($(this).find('i').text() != 0) {
                var x = {product_id: $(this).attr('id'), product_number: $(this).find('i').text()};
                result.push(x)
            }
        });


        $.ajax({
            url: furl + 'groupbuying/api/SubShopList',
            type: 'POST',
            data: {
                value: result,
                open_id: openid,
                group_number: group_number,//第几期
                order_number: group_number + '|' + openid,//订单号
                p_single: 0,
                rc_id: 0
            },
            async: false,
            dataType: 'json',
            xhrFields: {
                withCredentials: true
            },
            crossDomain: true,
            function(res) {
                console.log(res);
                if (res == '0') {
                    alert('提交失败');
                }
                if (res == '1') {

                    alert('提交成功');
                    setTimeout('window.location.reload()', 500);
                }
                if (res == '-1') {
                    alert('未到开团时间');
                }
            }
        });


    }

</script>

</body>
</html>