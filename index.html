<!doctype html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"
          name="viewport">
    <title>buy</title>
    <script src="./static/js/jquery-3.3.1.min.js" type="text/javascript"></script>
    <script src="./static/js/clipboard.min.js" type="text/javascript"></script>
    <script src="http://res.wx.qq.com/open/js/jweixin-1.4.0.js" type="text/javascript"></script>

    <script src="./static/js/vconsole.min.js"></script>
    <!--<script>var vConsole = new VConsole();</script>-->

    <script src="static/js/common.js"></script>
    <link href="./static/css/styles.css" rel="stylesheet" type="text/css">
    <link href="./static/css/weui.css" rel="stylesheet" type="text/css">
</head>
<body>


<div id="tip">

    <div class="weui-cell weui-cell_switch">
        <div class="weui-cell__bd">团长您好</div>
        <div class="weui-cell__ft">添加假单
            <input class="weui-switch" id="false-from" onclick="$('#false-div').toggle();" type="checkbox"></div>
    </div>


    <div class="weui-cell" id="false-div" style="display: none">
        <div class="weui-cell__hd"><label class="weui-label">假名</label></div>
        <div class="weui-cell__bd">
            <input class="weui-input" id="false-name" placeholder="输入假名" type="text"/>
        </div>
    </div>

    <a class="weui-btn weui-btn_mini weui-btn_default" href="javascript:"
       onclick="$('#form-list').toggle();$('#bought').hide();$('.buying').hide()">订单列表</a>
    <a class="weui-btn weui-btn_mini weui-btn_default" href="javascript:"
       onclick="$('#bought').hide();$('.buying').toggle();$('#form-list').hide()">下单界面</a>
    <a class="weui-btn weui-btn_mini weui-btn_default" href="javascript:"
       onclick="$('#text-copy #text1').empty().append(start_copy_text);$('#bought').hide();$('#text-copy').toggle()">开团单</a>
    <a class="weui-btn weui-btn_mini weui-btn_default" href="javascript:"
       onclick="over_order();$('#bought').hide();$('#text-copy').toggle()">结团单</a>
    <a class="weui-btn weui-btn_mini weui-btn_default" href="javascript:"
       onclick="get_order()">提货单</a>

    <div id="form-list" style="display: none"></div>

    <div id="text-copy" style="display: none">
        <div id="text1"></div>
        <a class="weui-btn weui-btn_plain-primary" data-clipboard-target="#text1" href="javascript:" id="copy-button"
           onclick="$('.opacity').toggle();">复制并关闭</a>
    </div>

</div>

<div id="bought">
    <div id="title">的购物清单</div>
    <div id="share-tip"><img src="static/images/share.png"></div>
    <div id="bought_list">
        <table></table>
        <div id="all-money"></div>
        <div id="bought-bs">
            <div class="bought-button" id="delete-this">重新<br>下单</div>
            <div class="bought-button" id="share-this">分享<br>订单</div>
        </div>
    </div>
</div>

<div class="opacity"></div>

<div id="none"></div>

<div class="right_box buying"></div>

<div class="clearfix"></div>

<div class="footer buying">
    <div id="buy_list">
        <table></table>
    </div>
    <div class="left" onclick="show_buy_list()">
        已选：<span id="cartN">
             <span class="reset" id="totalcountshow">0</span>份　总计：￥<span class="reset" id="totalpriceshow">0</span>
           </span>元<span style="font-size:10px;">&nbsp;&nbsp;查看购物车</span>
    </div>
    <div class="right">
        <a class="xhlbtn" href="javascript:void(0)" id="btnselect" onclick="submit();">选好了</a>
    </div>
</div>


<script>
    var furl = 'http://47.93.220.57/groupbuying/api';
    var group_number, openid, rc, client_name, order_number, code, share_imgurl;
    var start_copy_text = '', over_copy_text = '';
    var all_money = 0;
    var curl = location.href.split('#')[0];

    //复制
    var copyBtn = new ClipboardJS('#copy-button');

    copyBtn.on("success", function (e) {
        // 复制成功
        alert('复制成功');
        $('.opacity').hide();
        $('#text-copy').hide();
        e.clearSelection();
    });

    //初始化  有openID时直接 没有时先获取  重置页面的一些值
    function init(code) {
        $('.reset').text(0);

        if (localStorage.openid && localStorage.openid != 'undefined') {
            var temp_data = {openId: localStorage.openid, client_name: localStorage.client_name};
            var temp_url = furl + '/Get_Product_2'
        } else {
            //获取openID
            var temp_data = {'code': code};
            var temp_url = furl + "/Get_Product_1/5";
        }
        ajax({
            url: temp_url,
            data: temp_data,
            type: 'get',
            success: function (all) {
                localStorage.rc_id = all.rc_id;
                if (all.isreg == '0') {
                    window.location.href = 'https://open.weixin.qq.com/connect/oauth2/authorize?appid=wx4acf59cd381f3e28&redirect_uri=http%3a%2f%2fxmhome.xyz%2fConch%2fnormal-register.html&response_type=code&scope=snsapi_userinfo&state=STATE#wechat_redirect'
                }

                if (!localStorage.openid || localStorage.openid == 'undefined') {
                    localStorage.openid = all.open_id;
                    localStorage.client_name = all.client_name;
                }
                group_number = all.group_number;
                rc = all.isrc; //是否团长
                if (rc == '1') {
                    $('#tip').show();
                    $('#bought').hide();
                    //获取假单列表  真单走老接口
                    ajax({
                        url: furl + '/GetRCPSingle',
                        type: 'get',
                        data: {rc_id: 0},
                        success: function (res) {
                            var temp_text = '<div class="weui-cells__title">订单列表</div>';
                            for (var i in res.ordernumber) {
                                temp_text = temp_text + `<a class="weui-cell weui-cell_access" onclick="false_order('${res.ordernumber[i]}')"><div class="weui-cell__bd"><p>${parseInt(i)}</p></div><div class="weui-cell__ft">假单</div></a>`
                            }
                            $('#form-list').append(temp_text)
                        }
                    });
                    //todo获取商品列表 加开团单
                    ajax({
                        url: furl + '/Get_Product_2/5',
                        type: 'get',
                        success: function (res) {
                            $('.footer').show();
                            for (var i in res) {
                                start_copy_text = start_copy_text + (parseInt(i) + 1) + '&nbsp&nbsp' + res[i].product_name + '&nbsp&nbsp￥' + res[i].product_price + '<br>' + res[i].product_intro + '<br>'
                                var card1 = '<div class="pInfo" id="' + res[i].product_id + '"><img src="' + res[i].product_picture_url + '"/><div class="text"><p class="x-title">' + res[i].product_name + '</p> <p class="x-context">' + res[i].product_intro + '</p> </div><div class="right_content"> <div class="price">￥' + res[i].product_price + '</div> <div class="btn"><button class="minus" disabled="disabled">-</button><i>0</i><button class="add">+</button></div></div></div>'
                                $('.right_box').append(card1);
                            }
                        }
                    })
                }
                //已买
                if (all.bought == 1) {
                    if (rc != '1') {
                        var share_text = '';
                        all_money = 0;
                        order_number = all.order_number;
                        $('#bought #title').text(all.client_name + '的购物清单');
                        $('#bought').show();
                        $('#share-tip').hide();

                        for (var i in all.product) {
                            share_text = share_text + all.product[i].product_name + ' ';
                            console.log(all_money);
                            var temp_money = parseFloat((all.product[i].product_number * all.product[i].product_price).toFixed(2));
                            all_money = all_money + temp_money;
                            var card1 = '<tr><td>' + all.product[i].product_name + '</td> <td>x' + all.product[i].product_number + '=￥' + temp_money + '</td></tr>';
                            $('#bought_list table').append(card1);
                        }


                        $('#all-money').text('共' + all_money.toFixed(2) + '元');
                        wx_share(share_text + '...');
                    }
                    if (rc == '1') {
                        order_number = all.order_number;
                        var temp_text = `<a class="weui-cell weui-cell_access" onclick="false_order('${order_number}')"><div class="weui-cell__bd"><p>1</p></div><div class="weui-cell__ft">真单</div></a>`
                        $('#form-list').append(temp_text);

                    }
                }
                //未买
                if (all.bought == 0 && rc != '1') {
                    $('#bought_list table').empty();
                    $('.footer').show();
                    if (all.product == false) {
                        alert('未到开团时间')
                    }
                    for (var i in all.product) {
                        var card1 = '<div class="pInfo" id="' + all.product[i].product_id + '"><img src="' + all.product[i].product_picture_url + '"/><div class="text"><p class="x-title">' + all.product[i].product_name + '</p> <p class="x-context">' + all.product[i].product_intro + '</p> </div><div class="right_content"> <div class="price">￥' + all.product[i].product_price + '</div> <div class="btn"><button class="minus" disabled="disabled">-</button><i>0</i><button class="add">+</button></div></div></div>'
                        $('.right_box').append(card1);
                    }
                }
            }
        });
        ajax({
            url: furl + '/GetSignature',
            type: 'get',
            data: {url: encodeURIComponent(curl)},
            success: function (res) {
                wx.config({
                    debug: false, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
                    appId: 'wx4acf59cd381f3e28', // 必填，公众号的唯一标识
                    timestamp: res.timestamp, // 必填，生成签名的时间戳
                    nonceStr: res.nonceStr, // 必填，生成签名的随机串
                    signature: res.signature,// 必填，签名
                    jsApiList: ['onMenuShareAppMessage', //1.0 分享到朋友
                        'onMenuShareTimeline', //1.0分享到朋友圈
                        'updateAppMessageShareData', //1.4 分享到朋友
                        'updateTimelineShareData',
                        'showMenuItems'] //1.4分享到朋友圈
                });
            }
        })
    }

    $(document).ready(function () {
        code = Request['code'];
        init(code);
        //监视动态结点  添加事件
        $('.right_box').on('click', '.add', function () {
            $(this).prev().prev().removeAttr("disabled");
            var n = $(this).prev().text();
            var num = parseInt(n) + 1;
            if (num == 0) {
                return;
            }
            $(this).prev().text(num);
            var danjia = $(this).parent().siblings('.price').text().replace('￥', '');//获取单价
            var a = $("#totalpriceshow").html();//获取当前所选总价
            $("#totalpriceshow").html((a * 1 + danjia * 1).toFixed(2));//计算当前所选总价
            var nm = $("#totalcountshow").html();//获取数量
            $("#totalcountshow").html(nm * 1 + 1);
        });
        //减的效果
        $('.right_box').on('click', '.minus', function () {
            var n = $(this).next().text();
            var num = parseInt(n) - 1;
            $(this).next().text(num);//减1
            var danjia = $(this).parent().siblings('.price').text().replace('￥', '');
            var a = $("#totalpriceshow").html();//获取当前所选总价
            $("#totalpriceshow").html((a * 1 - danjia * 1).toFixed(2));//计算当前所选总价

            var nm = $("#totalcountshow").html();//获取数量
            $("#totalcountshow").html(nm * 1 - 1);
            //如果数量小于或等于0则隐藏减号和数量
            if (num <= 0) {
                $(this).attr("disabled", "true");
                $(this).attr("disabled", true);
                return
            }
        });
    });

    //结团单
    function over_order() {
        over_copy_text = ''
        ajax(
            {
                url: furl + '/GetShopList2?rc_id=0',
                success: function (all) {
                    var res = all.product;
                    for (var i in res) {
                        over_copy_text = over_copy_text + res[i].client_name + '<br>'
                        for (var j in res[i].products) {
                            over_copy_text = over_copy_text + res[i].products[j].product_name + 'X' + res[i].products[j].product_number + '&nbsp&nbsp'
                        }
                        over_copy_text = over_copy_text + '<br>';
                    }
                    $('#text-copy #text1').empty().append(over_copy_text);
                }


            }
        )
    }

    //提货单
    function get_order() {
        ajax({
            url: 'http://xmhome.xyz/groupbuying/api/GetRcExcel?rc_id=' + localStorage.openid,
            type: 'get',
            success: function (res) {
                location.href = res
            }
        })


    }

</script>

<script src="static/js/index1.js"></script>

</body>
</html>



